name: Build Blender Extension

on:
  push:
    tags:
      - 'v*'   # run on version tags like v1.0.0
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Blender
        run: |
          # Download Blender 5.0 (adjust version as needed)
          wget https://download.blender.org/release/Blender5.0/blender-5.0.0-linux-x64.tar.xz
          tar -xf blender-5.0.0-linux-x64.tar.xz
          # Add Blender to PATH
          echo "${{ github.workspace }}/blender-5.0.0-linux-x64" >> $GITHUB_PATH

      - name: Build extension with platform splits
        run: |
          mkdir -p ./builds
          blender-5.0.0-linux-x64/blender --background --command extension build --split-platforms --source-dir extension --output-dir ./builds

      - name: List generated builds
        run: |
          echo "Generated extension packages:"
          ls -lh ./builds/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: blender-extension-all-platforms
          path: ./builds/*.zip

      - name: Upload release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ./builds/*.zip
          body: |
            ## DICOM to VDB Extension - Platform-Specific Builds
            
            Download the appropriate version for your system:
            - **Windows**: `DCM2VDB-*-windows-x64.zip`
            - **macOS (Apple Silicon)**: `DCM2VDB-*-macos-arm64.zip`
            - **Linux**: `DCM2VDB-*-linux-x64.zip`
            
            ### Installation
            1. Download the zip file for your platform
            2. In Blender, go to Edit > Preferences > Extensions
            3. Click the dropdown menu (âŒ„) and select "Install from Disk"
            4. Select the downloaded zip file
            
            Each package is under 100MB and includes all necessary dependencies for that platform.
          draft: false
          prerelease: false

